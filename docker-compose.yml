version: "3.8"
services:
    spark-master:
        image: spark-master
        ports:
            - 4040:4040
            - 7077:7077
        volumes:
            - ./logs:/usr/bin/spark/logs
        environment:
            - "SPARK_MASTER_HOST=spark-master"
    spark-worker:
        image: spark-worker
        depends_on:
            - spark-master
        environment:
            - "SPARK_MASTER_URI=spark://spark-master:7077"
    prometheus:
        image: prom/prometheus
        volumes:
            - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
        command:
            - "--config.file=/etc/prometheus/prometheus.yml"
        ports:
            - "9090:9090"
        depends_on:
            - cadvisor
    cadvisor:
        image: google/cadvisor
        ports:
            - "8080:8080"
        volumes:
            - "/:/rootfs:ro"
            - "/var/run:/var/run:ro"
            - "/sys:/sys:ro"
            - "/var/lib/docker/:/var/lib/docker:ro"
            - "/dev/disk/:/dev/disk:ro"

    gitlab-runner:
        image: gitlab/gitlab-runner
        restart: always
        volumes:
            - "gitlab-runner:/etc/gitlab-runner"
            - "/var/run/docker.sock:/var/run/docker.sock"
        environment:
            - "GITLAB_URL=https://gitlab.com/"
            - "GITLAB_TOKEN=mpCBWzZzhaaJrdqjXYZq"
        command:
            - register
            - -n
            - --name "Docker Runner"
            - --executor docker
            - --docker-image docker:latest
            - --docker-volumes /var/run/docker.sock:/var/run/docker.sock
            - --url $GITLAB_URL
            - --registration-token $GITLAB_TOKEN
            - --tag-list spark-submit
